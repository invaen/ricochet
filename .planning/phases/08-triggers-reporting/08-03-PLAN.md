---
phase: 08-triggers-reporting
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ricochet/triggers/suggestions.py
  - ricochet/triggers/__init__.py
  - ricochet/cli.py
  - tests/test_triggers_suggestions.py
autonomous: true

must_haves:
  truths:
    - "Tool suggests likely trigger points based on injection context"
    - "Suggestions include location, likelihood, and manual steps"
    - "User can view suggestions for past injections"
  artifacts:
    - path: "ricochet/triggers/suggestions.py"
      provides: "TriggerSuggester and TRIGGER_MAP"
      exports: ["TriggerSuggester", "TriggerSuggestion", "TRIGGER_MAP"]
    - path: "tests/test_triggers_suggestions.py"
      provides: "Unit tests for suggestion logic"
  key_links:
    - from: "ricochet/triggers/suggestions.py"
      to: "ricochet/core/store.py"
      via: "InjectionRecord.parameter context"
      pattern: "InjectionRecord"
    - from: "ricochet/cli.py"
      to: "ricochet/triggers/suggestions.py"
      via: "cmd_suggest import"
      pattern: "from ricochet\\.triggers\\.suggestions import"
---

<objective>
Implement trigger suggestion engine based on injection context

Purpose: Guide users toward likely second-order execution points based on where their payloads were injected. For example, injections into "name" parameters likely execute in admin user lists, while "comment" injections likely execute in moderation queues.

Output: TriggerSuggester class with context-to-trigger mapping, CLI `suggest` subcommand.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-triggers-reporting/08-RESEARCH.md

# Existing infrastructure
@ricochet/core/store.py
@ricochet/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create suggestion module with trigger map</name>
  <files>ricochet/triggers/suggestions.py, ricochet/triggers/__init__.py</files>
  <action>
Create trigger suggestion infrastructure:

1. Create `ricochet/triggers/suggestions.py` with:

   - `TriggerSuggestion` dataclass:
     - location: str (e.g., "Admin User List")
     - likelihood: Literal['high', 'medium', 'low']
     - description: str (why this is likely)
     - manual_steps: list[str] (steps to trigger manually)

   - `TRIGGER_MAP` dict mapping injection contexts to suggestions (from research):
     ```python
     TRIGGER_MAP: dict[str, list[TriggerSuggestion]] = {
         # Parameter name patterns
         'name': [
             TriggerSuggestion(
                 location="Admin User List",
                 likelihood="high",
                 description="User names often displayed in admin dashboards",
                 manual_steps=[
                     "Log into admin panel",
                     "Navigate to User Management",
                     "View user list or search for injected user"
                 ]
             ),
             TriggerSuggestion(
                 location="Activity Logs",
                 likelihood="medium",
                 description="User activity may be logged with name field",
                 manual_steps=[
                     "Access activity/audit log viewer",
                     "Filter by recent activity",
                     "Review entries containing injected data"
                 ]
             ),
         ],
         'comment': [
             TriggerSuggestion(
                 location="Content Moderation Queue",
                 likelihood="high",
                 description="Comments typically reviewed before publishing",
                 manual_steps=[
                     "Access moderation dashboard",
                     "Review pending comments",
                     "View comment detail page"
                 ]
             ),
         ],
         'message': [
             TriggerSuggestion(
                 location="Support Ticket Dashboard",
                 likelihood="high",
                 description="Messages often reviewed by support staff",
                 manual_steps=[
                     "Access support/helpdesk dashboard",
                     "View pending tickets",
                     "Open ticket detail"
                 ]
             ),
         ],
         'user-agent': [
             TriggerSuggestion(
                 location="Analytics Dashboard",
                 likelihood="medium",
                 description="User-Agent strings logged for analytics",
                 manual_steps=[
                     "Access analytics or reporting dashboard",
                     "View visitor/session details",
                     "Check raw request logs"
                 ]
             ),
         ],
         'referer': [
             TriggerSuggestion(
                 location="Access Logs Viewer",
                 likelihood="medium",
                 description="Referer headers displayed in admin logs",
                 manual_steps=[
                     "Access admin log viewer",
                     "Filter by recent requests",
                     "View request details"
                 ]
             ),
         ],
         'email': [
             TriggerSuggestion(
                 location="Admin User List",
                 likelihood="high",
                 description="Email addresses displayed in user management",
                 manual_steps=[
                     "Access admin panel",
                     "Navigate to user list",
                     "Search or filter by email"
                 ]
             ),
         ],
         'search': [
             TriggerSuggestion(
                 location="Search Analytics",
                 likelihood="medium",
                 description="Search queries often logged for analytics",
                 manual_steps=[
                     "Access search analytics dashboard",
                     "View popular/recent searches",
                     "Check search logs"
                 ]
             ),
         ],
     }
     ```

   - `TriggerSuggester` class:
     - get_suggestions(parameter: str, context: str | None = None) -> list[TriggerSuggestion]
       - Extract base parameter name (e.g., "user_name" -> "name")
       - Look up in TRIGGER_MAP by parameter patterns
       - Include context-specific suggestions if provided
       - Return sorted by likelihood (high first)
     - get_suggestions_for_injection(injection: InjectionRecord) -> list[TriggerSuggestion]
       - Convenience method using injection.parameter and injection.context

2. Update `ricochet/triggers/__init__.py`:
   - Add exports: TriggerSuggester, TriggerSuggestion, TRIGGER_MAP

Parameter matching should be fuzzy: "user_name", "username", "name" all match "name" pattern.
Use simple substring matching for v1.
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -c "from ricochet.triggers.suggestions import TriggerSuggester; s = TriggerSuggester(); print(s.get_suggestions('comment')[0].location)"
```
Should print "Content Moderation Queue".
  </verify>
  <done>TriggerSuggester returns contextual suggestions, TRIGGER_MAP covers common parameters</done>
</task>

<task type="auto">
  <name>Task 2: Add suggest CLI subcommand</name>
  <files>ricochet/cli.py</files>
  <action>
Add `suggest` subcommand to CLI for trigger suggestions:

1. Add suggest_parser:
   ```python
   suggest_parser = subparsers.add_parser(
       'suggest',
       help='Show likely trigger points for injections'
   )
   ```

2. Add arguments:
   - --correlation-id (optional): Show suggestions for specific injection
   - --param (optional): Show suggestions for a parameter name
   - --recent (optional, default 10): Show suggestions for N most recent injections

3. Create cmd_suggest(args, store) -> int:
   - If --correlation-id: load injection, show suggestions
   - If --param: show suggestions for that parameter
   - If neither: show suggestions for --recent most recent injections

   Output format:
   ```
   === Trigger Suggestions ===

   Injection: abc123def456...
   Parameter: comment
   Target: https://example.com/submit

   [HIGH] Content Moderation Queue
     Comments typically reviewed before publishing
     Steps:
       1. Access moderation dashboard
       2. Review pending comments
       3. View comment detail page

   [MEDIUM] Activity Logs
     ...
   ```

4. Set defaults: suggest_parser.set_defaults(func=cmd_suggest)
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -m ricochet suggest --help
```
Should show suggest options including --param and --correlation-id.
  </verify>
  <done>`ricochet suggest --help` shows options, command outputs formatted suggestions</done>
</task>

<task type="auto">
  <name>Task 3: Add unit tests for suggestion logic</name>
  <files>tests/test_triggers_suggestions.py</files>
  <action>
Create tests for suggestion module:

1. Test TriggerSuggestion dataclass:
   - Fields accessible

2. Test TRIGGER_MAP:
   - Contains expected keys (name, comment, message)
   - Values are lists of TriggerSuggestion

3. Test TriggerSuggester.get_suggestions:
   - Returns suggestions for exact match ("comment")
   - Returns suggestions for fuzzy match ("user_name" -> "name")
   - Returns empty list for unknown parameter
   - Results sorted by likelihood (high before medium)

4. Test TriggerSuggester.get_suggestions_for_injection:
   - Works with InjectionRecord
   - Uses parameter field correctly

Use pytest, create InjectionRecord fixtures.
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -m pytest tests/test_triggers_suggestions.py -v
```
  </verify>
  <done>All suggestion tests pass, coverage includes fuzzy matching and sorting</done>
</task>

</tasks>

<verification>
```bash
cd /Users/aidan/projects/security/ricochet

# Module imports
python -c "from ricochet.triggers import TriggerSuggester, TriggerSuggestion, TRIGGER_MAP"

# CLI command available
python -m ricochet suggest --help | grep -E "(param|correlation-id)"

# Tests pass
python -m pytest tests/test_triggers_suggestions.py -v

# Suggestions work
python -c "
from ricochet.triggers.suggestions import TriggerSuggester
s = TriggerSuggester()
for sug in s.get_suggestions('username'):
    print(f'[{sug.likelihood.upper()}] {sug.location}')
"
```
</verification>

<success_criteria>
- TRIGGER_MAP covers 7+ common parameter patterns (name, comment, message, email, etc.)
- TriggerSuggester matches fuzzy parameter names (username -> name)
- Suggestions include location, likelihood, description, and manual steps
- `ricochet suggest --param comment` shows relevant trigger points
- Results sorted by likelihood (high first)
</success_criteria>

<output>
After completion, create `.planning/phases/08-triggers-reporting/08-03-SUMMARY.md`
</output>
