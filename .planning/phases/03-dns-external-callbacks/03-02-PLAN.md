---
phase: 03-dns-external-callbacks
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ricochet/external/__init__.py
  - ricochet/external/interactsh.py
  - ricochet/cli.py
autonomous: true

must_haves:
  truths:
    - "User can configure Interactsh as callback target instead of local server"
    - "Interactsh callbacks are correlated with injections"
    - "User can generate Interactsh subdomain for a correlation ID"
  artifacts:
    - path: "ricochet/external/interactsh.py"
      provides: "Interactsh client for polling interactions"
      exports: ["InteractshClient", "InteractshInteraction"]
    - path: "ricochet/external/__init__.py"
      provides: "Package initialization"
    - path: "ricochet/cli.py"
      provides: "--interactsh flag and subdomain generation"
      contains: "--interactsh"
  key_links:
    - from: "ricochet/cli.py"
      to: "ricochet/external/interactsh.py"
      via: "lazy import for interactsh commands"
      pattern: "from ricochet\\.external\\.interactsh import"
    - from: "ricochet/external/interactsh.py"
      to: "ricochet/core/store.py"
      via: "store.record_callback()"
      pattern: "store\\.record_callback"
---

<objective>
Implement a minimal Interactsh client for polling external callback infrastructure.

Purpose: Interactsh provides free, globally-accessible callback infrastructure. Users testing firewalled targets need external callback endpoints that can be reached from anywhere.

Output: Working Interactsh client at ricochet/external/interactsh.py with CLI integration.

**Important limitation:** Public Interactsh servers require RSA+AES encryption. This implementation supports:
1. Self-hosted Interactsh servers with encryption disabled
2. Manual subdomain generation for use with external polling

Full encryption support would require external crypto dependencies, which violates ricochet's zero-deps constraint. Document this limitation clearly.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-dns-external-callbacks/03-RESEARCH.md

# Existing patterns
@ricochet/server/http.py
@ricochet/cli.py
@ricochet/core/store.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Interactsh client module</name>
  <files>ricochet/external/__init__.py, ricochet/external/interactsh.py</files>
  <action>
Create the external package and Interactsh client module.

Create ricochet/external/__init__.py:
- Empty file or minimal docstring

Create ricochet/external/interactsh.py:

InteractshInteraction dataclass:
- protocol: str (dns, http, smtp, etc.)
- unique_id: str (correlation ID portion)
- full_id: str (full subdomain)
- raw_request: str (request data)
- remote_address: str (source IP)
- timestamp: str (ISO format)

InteractshClient class:
- __init__(self, server: str, correlation_id: str, secret: str | None = None)
- server: Interactsh server hostname (e.g., "oast.pro")
- correlation_id: 16-char hex ID from ricochet
- secret: Optional secret for authenticated polling

Properties:
- subdomain -> str: Returns "{correlation_id}.{server}" format
- base_url -> str: Returns "https://{server}"

Methods:
- generate_url(protocol: str = "http") -> str:
  Returns callback URL for the given protocol
  HTTP: "http://{subdomain}/callback"
  DNS: Just return subdomain for DNS queries

- poll(self, store: 'InjectionStore' | None = None) -> list[InteractshInteraction]:
  Poll for interactions using urllib.request (stdlib)
  URL: {base_url}/poll?id={correlation_id}&secret={secret}
  Parse JSON response, extract 'data' array
  If store provided, record each interaction as callback
  Return list of InteractshInteraction

  IMPORTANT: Public servers require encryption - this will fail.
  Add comment explaining the limitation.
  Catch URLError and return empty list on failure.

Helper function:
- create_interactsh_client(store: InjectionStore, server: str = "oast.pro") -> InteractshClient:
  Generate correlation ID using store's pattern (if store has generate_id method)
  Or use secrets.token_hex(8) directly
  Return configured client

Module-level docstring explaining:
- Public servers require RSA+AES encryption (not implemented due to zero-deps)
- Works with self-hosted servers with encryption disabled
- Primarily useful for subdomain generation to use with external tooling
  </action>
  <verify>
python -c "from ricochet.external.interactsh import InteractshClient, InteractshInteraction; print('imports ok')"
  </verify>
  <done>Interactsh client module exists with dataclass and client class</done>
</task>

<task type="auto">
  <name>Task 2: Add interactsh subcommand to CLI</name>
  <files>ricochet/cli.py</files>
  <action>
Add interactsh subcommand for generating callback URLs and polling.

Add new subparser for 'interactsh':
```python
interactsh_parser = subparsers.add_parser(
    'interactsh',
    help='Generate Interactsh callback URLs or poll for interactions'
)
interactsh_parser.add_argument(
    'action',
    choices=['url', 'poll'],
    help='Action: url (generate callback URL) or poll (check for interactions)'
)
interactsh_parser.add_argument(
    '--server',
    default='oast.pro',
    help='Interactsh server (default: oast.pro)'
)
interactsh_parser.add_argument(
    '--correlation-id',
    help='Use specific correlation ID (generates new if not provided)'
)
interactsh_parser.add_argument(
    '--secret',
    help='Secret for authenticated polling'
)
interactsh_parser.set_defaults(func=cmd_interactsh)
```

Add cmd_interactsh(args, store) function:
- If action == 'url':
  - Get or generate correlation_id
  - Create InteractshClient
  - Print HTTP URL and DNS subdomain
  - If no existing injection, create placeholder injection record
  - Return 0

- If action == 'poll':
  - Require correlation_id (print error if missing)
  - Create InteractshClient
  - Call client.poll(store)
  - Print any interactions found
  - Note: Will fail on public servers (print warning about encryption)
  - Return 0

Example output for 'url':
```
Correlation ID: a1b2c3d4e5f67890
HTTP callback: http://a1b2c3d4e5f67890.oast.pro/callback
DNS callback: a1b2c3d4e5f67890.oast.pro

Note: Use these URLs in your payloads. Monitor for callbacks with:
  ricochet interactsh poll --correlation-id a1b2c3d4e5f67890

For public servers, use external tooling (interactsh-client) for polling.
```
  </action>
  <verify>
python -m ricochet interactsh --help
python -m ricochet interactsh url --help
  </verify>
  <done>CLI shows interactsh subcommand with url and poll actions</done>
</task>

<task type="auto">
  <name>Task 3: Verify Interactsh URL generation</name>
  <files></files>
  <action>
Verify the interactsh url command generates valid callback URLs.

Test procedure:
1. Run interactsh url command
2. Verify output contains correlation ID, HTTP URL, and DNS subdomain
3. Verify injection record was created in database

Commands:
```bash
# Generate Interactsh URL
python -m ricochet interactsh url

# Verify injection was recorded
python -c "
from ricochet.core.store import InjectionStore
store = InjectionStore()
injections = store.list_injections(limit=1)
if injections:
    inj = injections[0]
    print(f'ID: {inj.id}')
    print(f'Target: {inj.target_url}')
    print(f'Payload: {inj.payload}')
"
```

Expected output format:
- Correlation ID: 16 hex chars
- HTTP callback: http://{id}.oast.pro/callback
- DNS callback: {id}.oast.pro
  </action>
  <verify>Output contains valid correlation ID and formatted URLs</verify>
  <done>interactsh url command generates valid callback URLs and records injection</done>
</task>

</tasks>

<verification>
All verification checks:
1. `python -c "from ricochet.external.interactsh import InteractshClient"` - imports without error
2. `python -m ricochet interactsh url` - generates callback URLs
3. `python -m ricochet interactsh poll --correlation-id abc123` - attempts poll (may fail on public server)
4. Generated correlation ID is 16 hex chars
5. No external dependencies added
</verification>

<success_criteria>
- InteractshClient generates valid callback subdomains
- CLI interactsh url command outputs HTTP and DNS callback URLs
- Injection record created for tracking
- Clear documentation of encryption limitation
- Stdlib only (urllib.request for HTTP)
</success_criteria>

<output>
After completion, create `.planning/phases/03-dns-external-callbacks/03-02-SUMMARY.md`
</output>
