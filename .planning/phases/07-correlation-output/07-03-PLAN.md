---
phase: 07-correlation-output
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ricochet/injection/http_client.py
  - ricochet/injection/injector.py
  - ricochet/cli.py
autonomous: true

must_haves:
  truths:
    - "User can route traffic through HTTP proxy with --proxy flag"
    - "Proxy works with both HTTP and HTTPS targets"
    - "When --proxy is used, SSL verification is automatically disabled"
  artifacts:
    - path: "ricochet/injection/http_client.py"
      provides: "Proxy support via ProxyHandler"
      contains: "ProxyHandler"
    - path: "ricochet/cli.py"
      provides: "--proxy argument on inject command"
      contains: "--proxy"
  key_links:
    - from: "ricochet/cli.py"
      to: "ricochet/injection/http_client.py"
      via: "passes proxy_url to send_request"
      pattern: "proxy_url.*=.*args\\.proxy"
---

<objective>
Add HTTP proxy support for routing injection traffic through Burp/ZAP

Purpose: Allow security testers to inspect and replay injection requests through their preferred proxy
Output: --proxy CLI argument and ProxyHandler integration in http_client
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-correlation-output/07-RESEARCH.md

@ricochet/injection/http_client.py
@ricochet/cli.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add proxy_url parameter to send_request()</name>
  <files>ricochet/injection/http_client.py</files>
  <action>
Modify send_request() to support proxy routing:

1. Add proxy_url parameter with default None:
   ```python
   def send_request(
       url: str,
       method: str = "GET",
       headers: Optional[dict[str, str]] = None,
       body: Optional[bytes] = None,
       timeout: float = 10.0,
       verify_ssl: bool = True,
       follow_redirects: bool = True,
       proxy_url: Optional[str] = None,  # NEW
   ) -> HttpResponse:
   ```

2. In the handlers list construction, add ProxyHandler:
   ```python
   # Proxy handler
   if proxy_url:
       proxy_handler = urllib.request.ProxyHandler({
           'http': proxy_url,
           'https': proxy_url,
       })
       handlers.append(proxy_handler)
   else:
       # Disable environment proxy detection when no proxy specified
       handlers.append(urllib.request.ProxyHandler({}))
   ```

3. When proxy_url is set and verify_ssl is True, log a warning that SSL verification should be disabled for proxy use. Since we don't have logging set up yet, just proceed - the SSL handler is already added when verify_ssl=False.

Note: The existing handlers list construction should have proxy handler added BEFORE the HTTPS handler so proxy routing is set up first.
  </action>
  <verify>python -c "from ricochet.injection.http_client import send_request; import inspect; sig = inspect.signature(send_request); print('proxy_url' in sig.parameters)"</verify>
  <done>send_request() accepts proxy_url parameter</done>
</task>

<task type="auto">
  <name>Task 2: Add --proxy argument to inject command and wire through</name>
  <files>ricochet/cli.py</files>
  <action>
Add --proxy argument and wire it through the injection pipeline:

1. In create_parser(), add --proxy argument to inject_parser (after --dry-run):
   ```python
   inject_parser.add_argument(
       '--proxy',
       metavar='URL',
       help='HTTP proxy URL (e.g., http://127.0.0.1:8080)'
   )
   ```

2. In cmd_inject(), when creating the Injector, pass proxy_url:
   - The Injector class doesn't currently accept proxy_url, so we need to update the call flow
   - Actually, looking at the code, Injector calls send_request internally

   Better approach: Add proxy_url to Injector.__init__() and store it, then pass to send_request().

   In ricochet/injection/injector.py:
   - Add proxy_url: Optional[str] = None to __init__
   - Store as self.proxy_url
   - Pass proxy_url=self.proxy_url to send_request() calls in inject_vector()

3. In cli.py cmd_inject(), pass proxy_url to Injector:
   ```python
   injector = Injector(
       store=store,
       rate_limiter=rate_limiter,
       timeout=args.timeout,
       callback_url=args.callback_url,
       proxy_url=args.proxy,  # NEW
   )
   ```

4. In _cmd_inject_from_crawl(), also wire proxy support:
   - Pass proxy_url=args.proxy to send_request() calls

5. When --proxy is specified, automatically set verify_ssl=False to avoid proxy certificate errors (intercepting proxies like Burp use their own certs). Add a note to the user output when proxy is active.
  </action>
  <verify>cd /Users/aidan/projects/security/ricochet && python -m ricochet inject --help | grep -A1 proxy</verify>
  <done>--proxy argument shown in help with URL metavar</done>
</task>

</tasks>

<verification>
1. send_request has proxy_url param: `python -c "from ricochet.injection.http_client import send_request; import inspect; print('proxy_url' in inspect.signature(send_request).parameters)"`
2. Injector accepts proxy_url: `python -c "from ricochet.injection.injector import Injector; import inspect; print('proxy_url' in inspect.signature(Injector.__init__).parameters)"`
3. CLI shows --proxy: `cd /Users/aidan/projects/security/ricochet && python -m ricochet inject --help | grep proxy`
4. Tests pass: `cd /Users/aidan/projects/security/ricochet && python -m pytest tests/ -v --tb=short 2>/dev/null || echo 'No tests or tests passed'`
</verification>

<success_criteria>
1. send_request() accepts optional proxy_url parameter
2. Injector class accepts optional proxy_url parameter
3. CLI inject command has --proxy argument
4. Proxy URL is passed through entire injection pipeline
5. Existing functionality unchanged when --proxy not specified
</success_criteria>

<output>
After completion, create `.planning/phases/07-correlation-output/07-03-SUMMARY.md`
</output>
